"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("reflect-metadata");
const express = require("express");
const morgan = require("morgan");
const bodyParser = require("body-parser");
const mongoose = require("mongoose");
const methodOverride = require("method-override");
const fs = require("fs-extra");
const hbs = require("hbs");
const routing_controllers_1 = require("routing-controllers");
const uniqueValidator = require("mongoose-unique-validator");
const nameSpaceHandler_1 = require("./utils/nameSpaceHandler");
const readConfig_1 = require("./utils/readConfig");
const errorHandler_1 = require("./utils/errorHandler");
exports.config = readConfig_1.recursiveIncludeJson('./config', 'config.json');
exports.app = express();
exports.router = express.Router();
exports.app.use(express.static('/web'));
exports.app.use(bodyParser.urlencoded({ 'extended': 'true' }));
exports.app.use(bodyParser.json());
exports.app.use(bodyParser.json({ type: 'application/vnd.api+json' }));
exports.app.use(methodOverride());
let hbsParam = exports.config.view.view_engine.handlebars;
var blocks = {};
hbs.registerHelper('extend', function (name, context) {
    var block = blocks[name];
    if (!block) {
        block = blocks[name] = [];
    }
    block.push(context.fn(this));
});
hbs.registerHelper('block', function (name) {
    var val = (blocks[name] || []).join('\n');
    blocks[name] = [];
    return val;
});
if (hbsParam.partials_location) {
    var registeredPartials = [];
    for (let i in hbsParam.partials_location) {
        let partial = hbsParam.partials_location[i];
        nameSpaceHandler_1.createNameSpace(partial.directory, partial.moduleNameRegex, '.', function (file, nameSpace) {
            if (registeredPartials.indexOf(nameSpace) === -1) {
                hbs.registerPartial(nameSpace, file);
                registeredPartials.push(nameSpace);
                console.log("register " + file + " as {{>" + nameSpace + "}}");
            }
            else {
                console.error("\x1b[31m%s\x1b[0m", "nameSpace error:fail to register " + file + " as {{>" + nameSpace + "}} \n"
                    + "check your partials directories to resolve conflict");
            }
        });
    }
}
exports.app.set('views', [__dirname + "/" + exports.config.view.directory + "/", __dirname + "/app/"]);
exports.app.set('view engine', 'hbs');
fs.remove(exports.config.public + "/app", function (err) {
    if (err)
        throw new Error(err);
    console.log("clear existing symlink to " + exports.config.public + "/app");
    nameSpaceHandler_1.createNameSpace('app/**/' + exports.config.public + '/', "app\/(.*)\/" + exports.config.public + "\/", '/', function (file, nameSpace) {
        fs.ensureSymlink(__dirname + "/" + file, __dirname + "/" + exports.config.public + '/app/' + nameSpace, function (err) {
            if (err)
                throw new Error(err);
            console.log("create symlink: " + file + " -> " + "app/" + nameSpace);
        });
    });
});
routing_controllers_1.useExpressServer(exports.app, {
    defaultErrorHandler: false,
    controllers: [__dirname + "/app/*/controllers/*{.js,.ts}"],
    middlewares: [__dirname + "/node_modules/**/middlewares/*{.js,.ts}"]
});
exports.app.use(exports.router);
switch (exports.config.env) {
    case 'dev':
        exports.app.use(morgan('dev'));
        break;
    case 'prod':
        exports.app.use(morgan('common', { skip: function (req, res) { return res.statusCode < 400; }, stream: __dirname + 'var/logs/prod.log' }));
        break;
}
exports.app.use(errorHandler_1.errorHandler);
let db = exports.config.database;
let dbConnectUri = db.driver + "://"
    + ((db.username && db.password) ?
        (db.username + ':' + db.password + "@") : '')
    + db.host
    + (db.port ? (':' + db.port) : '')
    + "/" + db.dbname;
mongoose.plugin(uniqueValidator);
mongoose.connect(dbConnectUri);
console.log("Connected to " + dbConnectUri);
let serv = exports.config.server;
exports.app.listen(serv.port, serv.host);
console.log("App listening " + serv.host + ":" + serv.port);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvc2ltb252aXZpZXIvd29ya3NwYWNlL2FwcGxpX2FuZ3VsYXIvbXlfZmlyc3RfYW5ndWxhcl9hcHAvc2VydmVyLnRzIiwic291cmNlcyI6WyIvaG9tZS9zaW1vbnZpdmllci93b3Jrc3BhY2UvYXBwbGlfYW5ndWxhci9teV9maXJzdF9hbmd1bGFyX2FwcC9zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw0QkFBMEI7QUFDMUIsbUNBQW1DO0FBQ25DLGlDQUFpQztBQUNqQywwQ0FBMEM7QUFDMUMscUNBQXFDO0FBQ3JDLGtEQUFrRDtBQUVsRCwrQkFBK0I7QUFDL0IsMkJBQTJCO0FBRTNCLDZEQUFxRDtBQUNyRCw2REFBNEQ7QUFJNUQsK0RBQXlEO0FBQ3pELG1EQUF3RDtBQUN4RCx1REFBa0Q7QUFPdkMsUUFBQSxNQUFNLEdBQUcsaUNBQW9CLENBQUMsVUFBVSxFQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3hELFFBQUEsR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBQ2QsUUFBQSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBR3ZDLFdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ2hDLFdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFDLFVBQVUsRUFBQyxNQUFNLEVBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEQsV0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUMzQixXQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDL0QsV0FBRyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBRzFCLElBQUksUUFBUSxHQUFHLGNBQU0sQ0FBQyxJQUFJLENBQUMsV0FB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QUFDLENBQUM7UUFDakksS0FBSyxDQUFDO0FBQ1IsQ0FBQztBQUVELFdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQVksQ0FBQyxDQUFDO0FBR3RCLElBQUksRUFBRSxHQUFHLGNBQU0sQ0FBQyxRQUFRLENBQUM7QUFDekIsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBQyxLQUFLO01BQzdCLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxRQUFRLENBQUM7UUFDMUIsQ0FBQyxFQUFFLENBQUMsUUFBUSxHQUFDLEdBQUcsR0FBQyxFQUFFLENBQUMsUUFBUSxHQUFDLEdBQUcsQ0FBQyxHQUFDLEVBQUUsQ0FDdkM7TUFDQSxFQUFFLENBQUMsSUFBSTtNQUNQLENBQUMsRUFBRSxDQUFDLElBQUksR0FBQyxDQUFDLEdBQUcsR0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUMsRUFBRSxDQUFDO01BQzFCLEdBQUcsR0FBQyxFQUFFLENBQUMsTUFBTSxDQUNqQjtBQUVELFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7QUFFakMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBQyxZQUFZLENBQUMsQ0FBQztBQUsxQyxJQUFJLElBQUksR0FBRyxjQUFNLENBQUMsTUFBTSxDQUFDO0FBQ3pCLFdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBQyxJQUFJLENBQUMsSUFBSSxHQUFDLEdBQUcsR0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzZXJ2ZXIuanNcbmltcG9ydCBcInJlZmxlY3QtbWV0YWRhdGFcIjtcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgKiBhcyBtb3JnYW4gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgKiBhcyBtZXRob2RPdmVycmlkZSBmcm9tICdtZXRob2Qtb3ZlcnJpZGUnO1xuLy8gaW1wb3J0ICogYXMgZnMgZnJvbSAnZmlsZS1zeXN0ZW0nO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgaGJzIGZyb20gJ2hicyc7XG5pbXBvcnQgKiBhcyBoYW5kbGViYXJzIGZyb20gJ2hhbmRsZWJhcnMnO1xuaW1wb3J0IHt1c2VFeHByZXNzU2VydmVyfSBmcm9tIFwicm91dGluZy1jb250cm9sbGVyc1wiO1xuaW1wb3J0ICogYXMgdW5pcXVlVmFsaWRhdG9yIGZyb20nbW9uZ29vc2UtdW5pcXVlLXZhbGlkYXRvcic7XG5pbXBvcnQgKiBhcyBsYXlvdXRzIGZyb20gJ2hhbmRsZWJhcnMtbGF5b3V0cyc7XG5pbXBvcnQgKiBhcyBnbG9iIGZyb20gJ2dsb2InO1xuXG5pbXBvcnQge2NyZWF0ZU5hbWVTcGFjZX0gZnJvbSAnLi91dGlscy9uYW1lU3BhY2VIYW5kbGVyJztcbmltcG9ydCB7cmVjdXJzaXZlSW5jbHVkZUpzb259IGZyb20gJy4vdXRpbHMvcmVhZENvbmZpZyc7XG5pbXBvcnQge2Vycm9ySGFuZGxlcn0gZnJvbSAnLi91dGlscy9lcnJvckhhbmRsZXInO1xuLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZGVjbGFyZSB2YXIgX19kaXJuYW1lO1xuLy8gPT09PT09PT09PT09PT1FeHBvcnQgY29tcG9uZW50LCAoY2FuIGJlIG5lZWRlZCBmcm9tIGNvbnRyb2xsZXJzKSA9PT09PT09PT09PT09PT09XG5leHBvcnQgbGV0IGNvbmZpZyA9IHJlY3Vyc2l2ZUluY2x1ZGVKc29uKCcuL2NvbmZpZycsJ2NvbmZpZy5qc29uJyk7XG5leHBvcnQgbGV0IGFwcCA9IGV4cHJlc3MoKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBvdXIgYXBwIHcvIGV4cHJlc3NcbmV4cG9ydCBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09U2V0IHVwIGV4cHJlc3MgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5hcHAudXNlKGV4cHJlc3Muc3RhdGljKCcvd2ViJykpOyAgICAgICAgICAgICAgICAgXHRcdFx0XHQvLyBzZXQgdGhlIHN0YXRpYyBmaWxlcyBsb2NhdGlvbiAvcHVibGljL2ltZyB3aWxsIGJlIC9pbWcgZm9yIHVzZXJzXG5hcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7J2V4dGVuZGVkJzondHJ1ZSd9KSk7ICAgICAgICAgICAgLy8gcGFyc2UgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyc2UgYXBwbGljYXRpb24vanNvblxuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oeyB0eXBlOiAnYXBwbGljYXRpb24vdm5kLmFwaStqc29uJyB9KSk7IC8vIHBhcnNlIGFwcGxpY2F0aW9uL3ZuZC5hcGkranNvbiBhcyBqc29uXG5hcHAudXNlKG1ldGhvZE92ZXJyaWRlKCkpO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT0gSGFuZGxlYmFycyAodGVtcGxhdGluZyBzeXN0ZW0pID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5sZXQgaGJzUGFyYW0gPSBjb25maWcudmlldy52aWV3X2VuZ2luZS5oYW5kbGViYXJzO1xuXG4vLyBBZGQgdGhlIGxheW91dCBzeXN0ZW0gdG8gaGFuZGxlYmFyc1xudmFyIGJsb2NrcyA9IHt9O1xuXG5oYnMucmVnaXN0ZXJIZWxwZXIoJ2V4dGVuZCcsIGZ1bmN0aW9uKG5hbWUsIGNvbnRleHQpIHtcbiAgICB2YXIgYmxvY2sgPSBibG9ja3NbbmFtZV07XG4gICAgaWYgKCFibG9jaykge1xuICAgICAgICBibG9jayA9IGJsb2Nrc1tuYW1lXSA9IFtdO1xuICAgIH1cblxuICAgIGJsb2NrLnB1c2goY29udGV4dC5mbih0aGlzKSk7IC8vIGZvciBvbGRlciB2ZXJzaW9ucyBvZiBoYW5kbGViYXJzLCB1c2UgYmxvY2sucHVzaChjb250ZXh0KHRoaXMpKTtcbn0pO1xuXG5oYnMucmVnaXN0ZXJIZWxwZXIoJ2Jsb2NrJywgZnVuY3Rpb24obmFtZSkge1xuICAgIHZhciB2YWwgPSAoYmxvY2tzW25hbWVdIHx8IFtdKS5qb2luKCdcXG4nKTtcbiAgICAvLyBjbGVhciB0aGUgYmxvY2tcbiAgICBibG9ja3NbbmFtZV0gPSBbXTtcbiAgICByZXR1cm4gdmFsO1xufSk7XG4vLyBSZWdpc3RlciBhbGwgcGFydGlhbHMgd2l0aCBuYW1lc3BhY2VcbmlmKGhic1BhcmFtLnBhcnRpYWxzX2xvY2F0aW9uKXtcblx0XHR2YXIgcmVnaXN0ZXJlZFBhcnRpYWxzID0gW107XG5cdFx0Zm9yIChsZXQgaSBpbiBoYnNQYXJhbS5wYXJ0aWFsc19sb2NhdGlvbil7XG5cdFx0XHRsZXQgcGFydGlhbCA9IGhic1BhcmFtLnBhcnRpYWxzX2xvY2F0aW9uW2ldO1xuXHRcdFx0Y3JlYXRlTmFtZVNwYWNlKHBhcnRpYWwuZGlyZWN0b3J5LHBhcnRpYWwubW9kdWxlTmFtZVJlZ2V4LCcuJyxmdW5jdGlvbihmaWxlLG5hbWVTcGFjZSl7XG5cdFx0XHRpZihyZWdpc3RlcmVkUGFydGlhbHMuaW5kZXhPZihuYW1lU3BhY2UpID09PSAtMSl7XG5cdFx0XHRcdGhicy5yZWdpc3RlclBhcnRpYWwobmFtZVNwYWNlLGZpbGUpO1xuXHRcdFx0XHRyZWdpc3RlcmVkUGFydGlhbHMucHVzaChuYW1lU3BhY2UpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhcInJlZ2lzdGVyIFwiK2ZpbGUrXCIgYXMge3s+XCIrbmFtZVNwYWNlK1wifX1cIik7XG5cdFx0XHR9ZWxzZXtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihcIlxceDFiWzMxbSVzXFx4MWJbMG1cIixcblx0XHRcdFx0XHRcdFwibmFtZVNwYWNlIGVycm9yOmZhaWwgdG8gcmVnaXN0ZXIgXCIrZmlsZStcIiBhcyB7ez5cIituYW1lU3BhY2UrXCJ9fSBcXG5cIiBcblx0XHRcdFx0XHRcdCtcImNoZWNrIHlvdXIgcGFydGlhbHMgZGlyZWN0b3JpZXMgdG8gcmVzb2x2ZSBjb25mbGljdFwiXG5cdFx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9KTtcdFxuXHR9XG59XG5cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gVmlld3MgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuYXBwLnNldCgndmlld3MnLFtfX2Rpcm5hbWUrXCIvXCIrY29uZmlnLnZpZXcuZGlyZWN0b3J5K1wiL1wiLF9fZGlybmFtZStcIi9hcHAvXCJdKTtcbmFwcC5zZXQoJ3ZpZXcgZW5naW5lJywgJ2hicycpO1xuXG4vLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09UHVibGljIGRpciA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy9DcmVhdGUgc3ltbGluayBmcm9tIGFwcCB0byBwdWJsaWMgZGlyXG5mcy5yZW1vdmUoY29uZmlnLnB1YmxpYytcIi9hcHBcIixmdW5jdGlvbihlcnIpe1xuXHRpZihlcnIpIHRocm93IG5ldyBFcnJvcihlcnIpO1xuXHRjb25zb2xlLmxvZyhcImNsZWFyIGV4aXN0aW5nIHN5bWxpbmsgdG8gXCIrY29uZmlnLnB1YmxpYytcIi9hcHBcIik7XHRcblx0Ly8gbGluayBhbGwgcHVibGljIGZyb20gYXBwIHRvIHB1YmxpYyBcblx0Y3JlYXRlTmFtZVNwYWNlKCdhcHAvKiovJytjb25maWcucHVibGljKycvJyxcImFwcFxcLyguKilcXC9cIitjb25maWcucHVibGljK1wiXFwvXCIsJy8nLGZ1bmN0aW9uKGZpbGUsbmFtZVNwYWNlKXtcblx0XHRmcy5lbnN1cmVTeW1saW5rKF9fZGlybmFtZStcIi9cIitmaWxlLF9fZGlybmFtZStcIi9cIitjb25maWcucHVibGljKycvYXBwLycrbmFtZVNwYWNlLGZ1bmN0aW9uKGVycil7XG5cdFx0XHRpZihlcnIpIHRocm93IG5ldyBFcnJvcihlcnIpO1xuXHRcdFx0Y29uc29sZS5sb2coXCJjcmVhdGUgc3ltbGluazogXCIrZmlsZStcIiAtPiBcIitcImFwcC9cIituYW1lU3BhY2UpO1xuXHRcdH0pO1xuXHR9KTtcbn0pO1xuLy89PT09PT09PT09PT09PT09PT09PT09IENvbnRyb2xsZXIvUm91dGluZyA9PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBSZWdpc3RlciBjb250cm9sbGVyXG51c2VFeHByZXNzU2VydmVyKGFwcCwge1xuXHRkZWZhdWx0RXJyb3JIYW5kbGVyOiBmYWxzZSwgLy8gd2UgdXNlIGN1c3RvbSBlcnJvciBoYW5kbGVyIFxuICAgIGNvbnRyb2xsZXJzOltfX2Rpcm5hbWUrXCIvYXBwLyovY29udHJvbGxlcnMvKnsuanMsLnRzfVwiXSxcbiAgICBtaWRkbGV3YXJlczogW19fZGlybmFtZSArIFwiL25vZGVfbW9kdWxlcy8qKi9taWRkbGV3YXJlcy8qey5qcywudHN9XCJdXG59KTtcbmFwcC51c2Uocm91dGVyKTtcbi8vPT09PT09PT09PT09PT09PT09PT09PT09PT1FcnJvciBoYW5kbGluZyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5zd2l0Y2goY29uZmlnLmVudil7XG5cdGNhc2UgJ2Rldic6XG5cdFx0Ly8gZGV2ZWxvcG1lbnQgZXJyb3IgaGFuZGxlclxuXHRcdC8vIHdpbGwgcHJpbnQgc3RhY2t0cmFjZVxuXHRcdGFwcC51c2UobW9yZ2FuKCdkZXYnKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblx0XHRicmVhaztcdFx0XG5cdGNhc2UgJ3Byb2QnOlxuXHRcdC8vIHByb2R1Y3Rpb24gZXJyb3IgaGFuZGxlclxuXHRcdC8vIG5vIHN0YWNrdHJhY2VzIGxlYWtlZCB0byB1c2VyXG5cdFx0YXBwLnVzZShtb3JnYW4oJ2NvbW1vbicsIHsgc2tpcDogZnVuY3Rpb24ocmVxLCByZXMpIHsgcmV0dXJuIHJlcy5zdGF0dXNDb2RlIDwgNDAwIH0sIHN0cmVhbTogX19kaXJuYW1lICsgJ3Zhci9sb2dzL3Byb2QubG9nJyB9KSk7XG5cdFx0YnJlYWs7XG59XG5cbmFwcC51c2UoZXJyb3JIYW5kbGVyKTtcblxuLy89PT09PT09PT09PT09PT09PT09PT09PT0gRGF0YWJhc2UgY29ubmVjdCAobW9uZ29vc2UpID09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5sZXQgZGIgPSBjb25maWcuZGF0YWJhc2U7XG5sZXQgZGJDb25uZWN0VXJpID0gZGIuZHJpdmVyK1wiOi8vXCJcbiAgICArKChkYi51c2VybmFtZSAmJiBkYi5wYXNzd29yZCk/XG4gICAgICAgIChkYi51c2VybmFtZSsnOicrZGIucGFzc3dvcmQrXCJAXCIpOicnXG4gICAgKVxuICAgICtkYi5ob3N0XG4gICAgKyhkYi5wb3J0PygnOicrZGIucG9ydCk6JycpXG4gICAgK1wiL1wiK2RiLmRibmFtZVxuO1xuLy9BZGQgcGx1Z2luIHRvIG1vbmdvb3NlIFxubW9uZ29vc2UucGx1Z2luKHVuaXF1ZVZhbGlkYXRvcik7XG4vL0Nvbm5lY3QgdG8gTW9uZ28gZGJcbm1vbmdvb3NlLmNvbm5lY3QoZGJDb25uZWN0VXJpKTtcbmNvbnNvbGUubG9nKFwiQ29ubmVjdGVkIHRvIFwiK2RiQ29ubmVjdFVyaSk7XG5cblxuXG4vLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVN0YXJ0IHRoZSBzZXJ2ZXIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbmxldCBzZXJ2ID0gY29uZmlnLnNlcnZlcjtcbmFwcC5saXN0ZW4oc2Vydi5wb3J0LHNlcnYuaG9zdCk7XG5jb25zb2xlLmxvZyhcIkFwcCBsaXN0ZW5pbmcgXCIrc2Vydi5ob3N0K1wiOlwiK3NlcnYucG9ydCk7Il19